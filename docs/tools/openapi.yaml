openapi: 3.1.0
info:
  title: CrabPath API
  version: 1.0.0
  description: Memory graph operations for CrabPath
servers:
  - url: http://localhost:8000
    description: Local MCP/HTTP gateway target

paths:
  /query:
    post:
      summary: Run a query against the graph
      operationId: query
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryRequest'
      responses:
        '200':
          description: Query result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResponse'

  /migrate:
    post:
      summary: Migrate a workspace into a graph
      operationId: migrate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MigrateRequest'
      responses:
        '200':
          description: Migration result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrateResponse'

  /learn:
    post:
      summary: Update graph weights from a learned outcome
      operationId: learn
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LearnRequest'
      responses:
        '200':
          description: Learn result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResult'

  /stats:
    post:
      summary: Get graph statistics
      operationId: stats
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GraphPathRequest'
      responses:
        '200':
          description: Graph stats
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsResponse'

  /split:
    post:
      summary: Split a node into chunks
      operationId: split
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SplitRequest'
      responses:
        '200':
          description: Split result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResult'

  /add:
    post:
      summary: Add or update a node
      operationId: add
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddRequest'
      responses:
        '200':
          description: Add result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResult'

  /remove:
    post:
      summary: Remove a node
      operationId: remove
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RemoveRequest'
      responses:
        '200':
          description: Remove result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResult'

  /consolidate:
    post:
      summary: Consolidate weak graph edges
      operationId: consolidate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConsolidateRequest'
      responses:
        '200':
          description: Consolidate result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResult'

  /sim:
    post:
      summary: Run lifecycle simulation
      operationId: sim
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SimRequest'
      responses:
        '200':
          description: Simulation output
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimResponse'

  /health:
    post:
      summary: Measure graph health
      operationId: health
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HealthRequest'
      responses:
        '200':
          description: Health result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /evolve:
    post:
      summary: Append graph snapshot stats to a timeline
      operationId: evolve
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EvolveRequest'
      responses:
        '200':
          description: Evolve result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EvolveResponse'

  /snapshot:
    post:
      summary: Persist a session turn snapshot
      operationId: snapshot
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SnapshotRequest'
      responses:
        '200':
          description: Snapshot result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SnapshotResponse'

  /feedback:
    post:
      summary: Resolve attributable snapshot for a session
      operationId: feedback
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeedbackRequest'
      responses:
        '200':
          description: Feedback result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeedbackResponse'

components:
  schemas:
    GraphPathRequest:
      type: object
      required: [graph]
      properties:
        graph:
          type: string
          default: crabpath_graph.json

    QueryRequest:
      type: object
      required: [query]
      properties:
        query:
          type: string
        graph:
          type: string
          default: crabpath_graph.json
        index:
          type: string
          default: crabpath_embeddings.json
        top:
          type: integer
          default: 12

    QueryResponse:
      type: object
      properties:
        fired:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              content:
                type: string
              energy:
                type: number
        inhibited:
          type: array
          items:
            type: string
        guardrails:
          type: array
          items:
            type: string

    MigrateRequest:
      type: object
      required: [workspace, output_graph]
      properties:
        workspace:
          type: string
          default: ~/.openclaw/workspace
        session_logs:
          type: array
          items:
            type: string
        include_memory:
          type: boolean
          default: true
        include_docs:
          type: boolean
          default: false
        output_graph:
          type: string
        output_embeddings:
          type: string
        verbose:
          type: boolean
          default: false

    MigrateResponse:
      type: object
      properties:
        ok:
          type: boolean
        graph_path:
          type: string
        embeddings_path:
          type: string
          nullable: true
        info:
          type: object

    LearnRequest:
      type: object
      required: [fired_ids, outcome]
      properties:
        graph:
          type: string
          default: crabpath_graph.json
        outcome:
          type: number
        fired_ids:
          type: string
          description: Comma-separated node ids

    StatsResponse:
      type: object
      properties:
        nodes:
          type: integer
        edges:
          type: integer
        avg_weight:
          type: number
        top_hubs:
          type: array
          items:
            type: string

    SplitRequest:
      type: object
      required: [graph, node_id]
      properties:
        graph:
          type: string
          default: crabpath_graph.json
        node_id:
          type: string
        save:
          type: boolean
          default: false

    AddRequest:
      allOf:
        - $ref: '#/components/schemas/GraphPathRequest'
      required: [id, content]
      properties:
        id:
          type: string
        content:
          type: string
        threshold:
          type: number
        connect:
          type: string

    RemoveRequest:
      allOf:
        - $ref: '#/components/schemas/GraphPathRequest'
      required: [id]
      properties:
        id:
          type: string

    ConsolidateRequest:
      allOf:
        - $ref: '#/components/schemas/GraphPathRequest'
      properties:
        min_weight:
          type: number
          default: 0.05

    SimRequest:
      type: object
      required: [queries]
      properties:
        queries:
          type: integer
          minimum: 1
          default: 100
        decay_interval:
          type: integer
          minimum: 1
          default: 5
        decay_half_life:
          type: integer
          minimum: 1
          default: 80
        output:
          type: string

    SimResponse:
      type: object
      properties:
        ok:
          type: boolean
        result:
          type: object
          properties:
            bootstrap:
              type: object
            snapshots:
              type: array
              items:
                type: object
            final:
              type: object

    HealthRequest:
      allOf:
        - $ref: '#/components/schemas/GraphPathRequest'
        - type: object
          required: [graph]
          properties:
            mitosis_state:
              type: string
              description: Optional path to mitosis state JSON
            query_stats:
              type: object
              description: Optional query statistics payload

    HealthResponse:
      type: object
      properties:
        ok:
          type: boolean
        graph:
          type: string
        query_stats_provided:
          type: boolean
        mitosis_state:
          type: string
          nullable: true
        metrics:
          type: array
          items:
            $ref: '#/components/schemas/HealthMetric'

    HealthMetric:
      type: object
      properties:
        metric:
          type: string
        value:
          type: number
          nullable: true
        target_range:
          type: array
          items:
            type: number
            nullable: true
          minItems: 2
          maxItems: 2
        status:
          type: string

    EvolveRequest:
      allOf:
        - $ref: '#/components/schemas/GraphPathRequest'
        - type: object
          required: [snapshots]
          properties:
            snapshots:
              type: string
              description: Path to snapshots JSONL timeline
            report:
              type: boolean
              default: false

    EvolveResponse:
      type: object
      properties:
        ok:
          type: boolean
        snapshot:
          $ref: '#/components/schemas/SnapshotRecord'
        snapshots:
          type: string
        timeline:
          type: string

    SnapshotRecord:
      type: object
      properties:
        timestamp:
          type: number
        nodes:
          type: integer
        edges:
          type: integer
        tier_counts:
          type: object
          additionalProperties:
            type: integer
        cross_file_edges:
          type: integer

    SnapshotRequest:
      allOf:
        - $ref: '#/components/schemas/GraphPathRequest'
        - type: object
          required: [session, turn, fired_ids]
          properties:
            session:
              type: string
            turn:
              type: integer
            fired_ids:
              type: string
              description: Comma-separated fired node IDs

    SnapshotResponse:
      type: object
      properties:
        ok:
          type: boolean
        snapshot_path:
          type: string

    FeedbackRequest:
      type: object
      required: [session]
      properties:
        session:
          type: string
        turn_window:
          type: integer
          default: 5

    FeedbackResponse:
      type: object
      properties:
        turn_id:
          type: integer
        fired_ids:
          type: array
          items:
            type: string
        turns_since_fire:
          type: integer
        suggested_outcome:
          type: number

    GenericResult:
      type: object
      properties:
        ok:
          type: boolean
